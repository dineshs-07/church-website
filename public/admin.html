<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FGM</title>
    <style>
        /* All CSS styles are unchanged... */
        /* --- 1. Basic Setup & Fonts --- */
        :root {
            --theme-primary: #000604;
            --theme-secondary: #f39c12;
            --theme-dark: #2c3e50;
            --text-dark: #2c3e50;
            --text-light: #555;
            --bg-light: #f4f6f9; /* Admin background is slightly different */
            --bg-white: #ffffff;
            --sidebar-width: 260px;
        }

        body, html {
            margin: 0; padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow: hidden; /* No scroll on main body */
        }
        
        .admin-container {
            display: flex;
            height: 100vh;
        }

        /* --- 2. Sidebar --- */
        .admin-sidebar {
            width: var(--sidebar-width);
            background: var(--theme-dark);
            color: #eee;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 100;
        }
        .admin-sidebar .logo {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            color: var(--bg-white);
            text-transform: uppercase;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #4a5a6a;
        }
        .admin-sidebar .logo img {
            height: 40px;
            margin-right: 10px;
        }
        .admin-sidebar .nav-title {
            font-size: 12px;
            font-weight: 600;
            color: #9aabbc;
            text-transform: uppercase;
            margin: 20px 0 10px 0;
        }
        .admin-sidebar .sidebar-link {
            display: block;
            padding: 12px 15px;
            text-decoration: none;
            color: #e0e0e0;
            font-size: 15px;
            font-weight: 500;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .admin-sidebar .sidebar-link:hover {
            background-color: #4a5a6a;
        }
        .admin-sidebar .sidebar-link.active {
            background-color: var(--theme-secondary);
            color: var(--bg-white);
            font-weight: 600;
        }
        .admin-sidebar .logout {
            margin-top: auto;
        }

        /* --- 3. Main Content --- */
        .admin-main-content {
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            padding: 30px;
            box-sizing: border-box;
        }
        .admin-page {
            display: none; /* Hidden by default */
        }
        .admin-page.active {
            display: block; /* Shown by JS */
        }
        
        .admin-page h1 {
            font-size: 32px;
            font-weight: 800;
            color: var(--theme-primary);
            margin: 0 0 30px 0;
        }

        /* --- 4. Cards & Forms --- */
        .admin-card {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            padding: 30px;
            margin-bottom: 30px;
        }
        .admin-card h2 {
            font-size: 22px;
            color: var(--theme-primary);
            margin: 0 0 20px 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }
        .form-group textarea { min-height: 100px; }
        .form-group .current-image-preview {
            max-width: 100px;
            height: auto;
            border-radius: 5px;
            margin-top: 10px;
            display: block;
        }

        .btn-primary {
            background-color: var(--theme-primary);
            color: white;
            padding: 14px 30px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary:hover { background-color: #004a35; }
        
        .btn-secondary {
            background-color: var(--theme-secondary);
            color: white;
        }
        .btn-secondary:hover { background-color: #e67e22; }

        .btn-danger {
            background-color: #d9534f;
            color: white;
        }
        .btn-danger:hover { background-color: #c9302c; }

        .btn-light {
            background-color: #f4f4f4;
            color: #333;
            border: 1px solid #ccc;
        }
        .btn-light:hover { background-color: #e0e0e0; }


        /* --- 5. Current Items List --- */
        .current-item-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .current-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .current-item .item-info {
            display: flex;
            align-items: center;
            gap: 15px;
            /* Allow info to shrink to make room for buttons */
            min-width: 0;
            flex: 1;
        }
        .current-item .item-info img {
            width: 80px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            flex-shrink: 0;
        }
        .current-item .item-info div {
             /* Allow text to shrink and wrap */
             min-width: 0;
             flex: 1;
        }
        .current-item .item-info h3 {
            font-size: 16px;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .current-item .item-info p {
            font-size: 14px;
            color: var(--text-light);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .current-item .item-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        .current-item .item-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            font-size: 16px;
            line-height: 1;
            transition: background-color 0.2s;
        }
        .btn-delete { color: #d9534f; }
        .btn-delete:hover { background-color: #fce8e6; }
        .btn-edit { color: var(--theme-secondary); }
        .btn-edit:hover { background-color: #fef5e7; }

        /* --- 6. Edit Modal --- */
        .modal-backdrop {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1040;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-backdrop.show {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        .modal-backdrop.show .modal-content {
            transform: scale(1);
        }
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 22px;
            color: var(--theme-primary);
        }
        .modal-body {
            padding: 30px;
            overflow-y: auto;
        }
        .modal-footer {
            padding: 20px 30px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        
        <aside class="admin-sidebar">
            <div class="logo">
                <img src="logo.png" alt="Logo">
                FGM Admin
            </div>
            
            <a class="sidebar-link active" data-page="dashboard">Dashboard</a>
            
            <div class="nav-title">Manage Content</div>
            <a class="sidebar-link" data-page="manage-events">Events</a>
            <a class="sidebar-link" data-page="manage-locations">Locations</a>
            <a class="sidebar-link" data-page="manage-ministries">Ministries</a>
            <a class="sidebar-link" data-page="manage-gallery">Gallery</a>
            <a class="sidebar-link" data-page="manage-about">About Page</a>

            <div class="nav-title">Settings</div>
            <a class="sidebar-link" href="admin-login.html" class="logout">Logout</a>
        </aside>

        <main class="admin-main-content">

            <section class="admin-page active" id="dashboard">
                <h1>Dashboard</h1>
                <div class="admin-card">
                    <h2>Welcome, Admin!</h2>
                    <p>From here you can manage all the content on the Full Gospel Ministries website.</p>
                    <p>Use the links on the left to add, edit, or delete events, locations, gallery photos, and more.</p>
                </div>
            </section>

            <section class="admin-page" id="manage-events">
                <h1>Manage Events</h1>
                <div class="admin-card">
                    <h2>Add New Event</h2>
                    <form id="form-add-event">
                        <h3>Grid Card Info</h3>
                        <div class="form-group">
                            <label for="event-title">Event Title</label>
                            <input type="text" id="event-title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="event-subtitle">Event Subtitle (Date & Time)</label>
                            <input type="text" id="event-subtitle" name="subtitle" placeholder="e.g., October 26, 2025 @ 5:00 PM">
                        </div>
                        <div class="form-group">
                            <label for="event-description">Short Description (for card)</label>
                            <textarea id="event-description" name="description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="event-image">Grid Image (for card)</label>
                            <input type="file" id="event-image" name="image" accept="image/*">
                        </div>

                        <hr style="margin: 30px 0;">
                        <h3>Event Detail Page Info</h3>
                        <div class="form-group">
                            <label for="event-fullDescription">Full Event Details</label>
                            <textarea id="event-fullDescription" name="fullDescription" placeholder="Enter the full, detailed description for the event page..."></textarea>
                        </div>
                         <div class="form-group">
                            <label for="event-registrationNote">Registration Note</label>
                            <input type="text" id="event-registrationNote" name="registrationNote" placeholder="e.g., Free, but please register below!">
                        </div>
                        <div class="form-group">
                            <label for="event-detail-image">Detail Page Image (Optional)</label>
                            <input type="file" id="event-detail-image" name="detailImage" accept="image/*">
                        </div>

                        <button type="submit" class="btn-primary btn-secondary">Save New Event</button>
                    </form>
                </div>
                <div class="admin-card">
                    <h2>Current Events</h2>
                    <div class="current-item-list" id="events-list"></div>
                </div>
            </section>
            
            <section class="admin-page" id="manage-locations">
                <h1>Manage Locations</h1>
                <div class="admin-card">
                    <h2>Add New Location</h2>
                    <form id="form-add-location">
                        <h3>Grid Card Info</h3>
                        <div class="form-group">
                            <label for="loc-title">Campus Name (Title)</label>
                            <input type="text" id="loc-title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="loc-subtitle">Service Times (Subtitle)</label>
                            <input type="text" id="loc-subtitle" name="subtitle" placeholder="e.g., Sundays @ 9:00 AM & 11:00 AM">
                        </div>
                         <div class="form-group">
                            <label for="loc-description">Short Description (for card)</label>
                            <textarea id="loc-description" name="description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="loc-image">Grid Image (The image shown on the card)</label>
                            <input type="file" id="loc-image" name="image" accept="image/*">
                        </div>

                        <hr style="margin: 30px 0;">
                        <h3>Location Detail Page Info</h3>
                         <div class="form-group">
                            <label for="loc-pastorName">Pastor Name</label>
                            <input type="text" id="loc-pastorName" name="pastorName" placeholder="e.g., Pastors Jachin & Becca Mullen">
                        </div>
                         <div class="form-group">
                            <label for="loc-detail-image">Detail Page Image (e.g., Pastor's family photo)</label>
                            <input type="file" id="loc-detail-image" name="detailImage" accept="image/*">
                        </div>
                         <div class="form-group">
                            <label for="loc-phone">Phone</label>
                            <input type="text" id="loc-phone" name="phone" placeholder="e.g., 403.343.6570">
                        </div>
                         <div class="form-group">
                            <label for="loc-email">Email</label>
                            <input type="email" id="loc-email" name="email" placeholder="e.g., reddeer@myhomechurch.ca">
                        </div>
                         <div class="form-group">
                            <label for="loc-address">Address</label>
                            <textarea id="loc-address" name="address" placeholder="e.g., #1 England Way, Red Deer, Alberta"></textarea>
                        </div>
                         <div class="form-group">
                            <label for="loc-mailingAddress">Mailing Address</label>
                            <textarea id="loc-mailingAddress" name="mailingAddress" placeholder="e.g., 37557 Highway 2A, Red Deer County AB, T4E 1S2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="loc-googleMapEmbed">Google Map Embed Code</label>
                            <textarea id="loc-googleMapEmbed" name="googleMapEmbed" placeholder="Get this from Google Maps > Share > Embed a map. Copy the <iframe ...> code here."></textarea>
                        </div>

                        <button type="submit" class="btn-primary btn-secondary">Save New Location</button>
                    </form>
                </div>
                <div class="admin-card">
                    <h2>Current Locations</h2>
                    <div class="current-item-list" id="locations-list"></div>
                </div>
            </section>
            
            <section class="admin-page" id="manage-gallery">
                <h1>Manage Gallery</h1>
                <div class="admin-card">
                    <h2>Add New Photo</h2>
                     <form id="form-add-photo">
                        <div class="form-group">
                            <label for="photo-image">Image Upload</label>
                            <input type="file" id="photo-image" name="image" accept="image/*" required>
                        </div>
                        <div class="form-group">
                            <label for="photo-category">Category</label>
                            <select id="photo-category" name="category">
                                <option value="social">Social Work</option>
                                <option value="events">Events</option>
                                <option value="pastors">Pastors</option>
                                <option value="functions">Functions</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary btn-secondary">Add Photo to Gallery</button>
                    </form>
                </div>
                 <div class="admin-card">
                    <h2>Current Photos</h2>
                    <div class="current-item-list" id="gallery-list"></div>
                </div>
            </section>
            
            <section class="admin-page" id="manage-ministries">
                 <h1>Manage Ministries</h1>
                 <p>Forms for ministries would go here...</p>
            </section>
            
            <section class="admin-page" id="manage-about">
                <h1>Manage About Page</h1>
                <div class="admin-card">
                    <h2>Edit Page Content</h2>
                    <form id="form-manage-about">
                        <div class="form-group">
                            <label for="about-mission">Our Mission</label>
                            <textarea id="about-mission" name="ourMission" style="min-height: 150px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="about-story">Our Story</label>
                            <textarea id="about-story" name="ourStory" style="min-height: 250px;"></textarea>
                        </div>
                        <button type="submit" class="btn-primary btn-secondary">Save About Content</button>
                    </form>
                </div>
            </section>

        </main>
    </div>

    <div class="modal-backdrop" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="edit-modal-title">Edit Item</h2>
            </div>
            <form id="form-edit-item">
                <div class="modal-body">
                    <input type="hidden" id="edit-item-id" name="id">
                    <input type="hidden" id="edit-item-endpoint" name="endpoint">
                    <input type="hidden" id="edit-item-existing-image" name="existingImageUrl">
                    <input type="hidden" id="edit-item-existing-detail-image" name="existingDetailImageUrl">

                    <div class="form-group">
                        <label for="edit-title">Title</label>
                        <input type="text" id="edit-title" name="title" required>
                    </div>

                    <div class="form-group" id="edit-group-subtitle">
                        <label for="edit-subtitle">Subtitle</label>
                        <input type="text" id="edit-subtitle" name="subtitle">
                    </div>
                     <div class="form-group" id="edit-group-description">
                        <label for="edit-description">Description</label>
                        <textarea id="edit-description" name="description"></textarea>
                    </div>
                     <div class="form-group" id="edit-group-grid-image-preview">
                        <label>Current Grid Image</label>
                        <img src="" id="edit-current-image-preview" class="current-image-preview" alt="Current Grid Image">
                    </div>
                    <div class="form-group" id="edit-group-grid-image-upload">
                        <label for="edit-image-file">Upload New Grid Image (Optional)</label>
                        <input type="file" id="edit-image-file" name="image" accept="image/*">
                    </div>

                    <div class="form-group" id="edit-group-category">
                        <label for="edit-category">Category</label>
                        <select id="edit-category" name="category">
                            <option value="social">Social Work</option>
                            <option value="events">Events</option>
                            <option value="pastors">Pastors</option>
                            <option value="functions">Functions</option>
                        </select>
                    </div>

                    <div id="edit-group-location-details">
                        <hr style="margin: 30px 0;">
                        <h3>Location Detail Page Info</h3>
                        <div class="form-group">
                            <label for="edit-pastorName">Pastor Name</label>
                            <input type="text" id="edit-pastorName" name="pastorName">
                        </div>
                        <div class="form-group">
                            <label>Current Detail Page Image</label>
                            <img src="" id="edit-current-detail-image-preview" class="current-image-preview" alt="Current Detail Image">
                        </div>
                        <div class="form-group">
                            <label for="edit-detail-image-file">Upload New Detail Image (Optional)</label>
                            <input type="file" id="edit-detail-image-file" name="detailImage" accept="image/*">
                        </div>
                        <div class="form-group">
                            <label for="edit-phone">Phone</label>
                            <input type="text" id="edit-phone" name="phone">
                        </div>
                        <div class="form-group">
                            <label for="edit-email">Email</label>
                            <input type="email" id="edit-email" name="email">
                        </div>
                        <div class="form-group">
                            <label for="edit-address">Address</label>
                            <textarea id="edit-address" name="address"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-mailingAddress">Mailing Address</label>
                            <textarea id="edit-mailingAddress" name="mailingAddress"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-googleMapEmbed">Google Map Embed Code</label>
                            <textarea id="edit-googleMapEmbed" name="googleMapEmbed"></textarea>
                        </div>
                    </div>

                    <div id="edit-group-event-details">
                        <hr style="margin: 30px 0;">
                        <h3>Event Detail Page Info</h3>
                        <div class="form-group">
                            <label for="edit-fullDescription">Full Event Details</label>
                            <textarea id="edit-fullDescription" name="fullDescription"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="edit-registrationNote">Registration Note</label>
                            <input type="text" id="edit-registrationNote" name="registrationNote">
                        </div>
                        <div class="form-group">
                            <label>Current Detail Page Image</label>
                            <img src="" id="edit-current-event-detail-image-preview" class="current-image-preview" alt="Current Detail Image">
                        </div>
                        <div class="form-group">
                            <label for="edit-event-detail-image-file">Upload New Detail Image (Optional)</label>
                            <input type="file" id="edit-event-detail-image-file" name="detailImage" accept="image/*">
                        </div>
                    </div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-light" id="btn-cancel-edit">Cancel</button>
                    <button type="submit" class="btn-primary btn-secondary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // 🌟 --- FIX 1: SECURITY CHECK --- 🌟
        // Get the token *first*
        const token = localStorage.getItem('token'); 
        
        // Check if it exists
        if (!token) {
            // No token found, redirect to login
            alert('You are not logged in. Redirecting to login page.');
            window.location.href = 'admin-login.html'; // Make sure this is your login page
            return; // Stop running the rest of the script
        }
        // ---------------------------------
        
        const links = document.querySelectorAll('.sidebar-link');
        const pages = document.querySelectorAll('.admin-page');
        const mainContent = document.querySelector('.admin-main-content');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('form-edit-item');
        // const token = localStorage.getItem('token'); // This is now at the top

        let itemCache = {
            locations: [],
            events: [],
            gallery: []
        };

        // --- Page Switching Logic (Unchanged) ---
        links.forEach(link => {
            link.addEventListener('click', (e) => {
                // Don't prevent default if it's the logout link
                if (link.getAttribute('data-page')) e.preventDefault();
                
                const pageId = link.getAttribute('data-page');
                if (!pageId) return; // Exit if it's not a page-switching link (like logout)
                
                pages.forEach(page => page.classList.toggle('active', page.id === pageId));
                links.forEach(l => l.classList.toggle('active', l.getAttribute('data-page') === pageId));
            });
        });

        // 🌟 --- FIX 2: LOGOUT LOGIC --- 🌟
        const logoutLink = document.querySelector('.sidebar-link[href="admin-login.html"]');
        if (logoutLink) {
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault(); // Stop it from just navigating
                
                // Remove the token from storage
                localStorage.removeItem('token');
                
                // Redirect to the login page
                window.location.href = 'admin-login.html';
            });
        }
        // -----------------------------


        // --- sendFormData (For multipart/form-data) ---
        // This function is perfect as-is. It sends the token.
        async function sendFormData(endpoint, formData, method = 'POST') {
            try {
                const res = await fetch(endpoint, {
                    method: method,
                    headers: {
                        "Authorization": `Bearer ${token}`
                    },
                    body: formData
                });
                const result = await res.json();
                
                if (res.ok) {
                    alert(`Data ${method === 'POST' ? 'added' : 'updated'} successfully!`);
                    console.log(`✅ Data saved:`, result);
                    
                    if (endpoint.includes('locations')) {
                        loadDynamicData('locations', 'locations-list', renderListItem);
                    } else if (endpoint.includes('events')) {
                        loadDynamicData('events', 'events-list', renderListItem);
                    } else if (endpoint.includes('gallery')) {
                        loadDynamicData('gallery', 'gallery-list', renderGalleryItem);
                    }
                    
                    editModal.classList.remove('show');

                } else {
                    alert(`❌ Error: ${result.error || 'Something went wrong'}`);
                    console.error(result);
                }
            } catch (err) {
                console.error("❌ Network error:", err);
                alert("Network error while saving data");
            }
        }

        // --- 🌟 NEW: sendJSONData (for simple PUT requests like 'About') 🌟 ---
        async function sendJSONData(endpoint, data, method = 'PUT') {
            try {
                const res = await fetch(endpoint, {
                    method: method,
                    headers: {
                        "Content-Type": "application/json", // Key difference
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(data) // Key difference
                });
                const result = await res.json();
                
                if (res.ok) {
                    alert(`Data updated successfully!`);
                    console.log(`✅ Data saved:`, result);
                } else {
                    alert(`❌ Error: ${result.error || 'Something went wrong'}`);
                    console.error(result);
                }
            } catch (err) {
                console.error("❌ Network error:", err);
                alert("Network error while saving data");
            }
        }


        // --- fetchData (For GET requests) ---
        // This sends the token, which is fine. Public routes will ignore it.
        async function fetchData(endpoint) {
            try {
                // 🌟 Use a different header object for public vs private GET
                // Public routes don't need auth
                const isPublicApi = endpoint.startsWith('locations') || endpoint.startsWith('events') || endpoint.startsWith('gallery') || endpoint.startsWith('about');
                
                const headers = {};
                if (!isPublicApi) {
                    // Only add auth token for private admin calls (if you had any)
                    // For now, all our GETs are public, but this is safer
                    headers["Authorization"] = `Bearer ${token}`;
                }

                const res = await fetch(`/api/${endpoint}`, {
                    method: "GET",
                    headers: headers // Use the correct headers
                });
                
                // 🌟 NEW: Check for 403 Forbidden (e.g., if token expired on a *private* route)
                if (res.status === 403) {
                    alert('Your session has expired. Please log in again.');
                    localStorage.removeItem('token');
                    window.location.href = 'admin-login.html';
                    return [];
                }
                
                if (!res.ok) throw new Error(`Failed to fetch ${endpoint}`);
                return await res.json();
            } catch (err) {
                console.error(`❌ Error fetching ${endpoint}:`, err);
                return [];
            }
        }

        // --- Renderers (Unchanged) ---
        function renderListItem(item) {
            const imageUrl = item.imageUrl ? `/${item.imageUrl}` : 'https://placehold.co/400x200/ccc/white?text=No+Image';
            return `
                <div class="current-item" data-id="${item.id}">
                    <div class="item-info">
                        <img src="${imageUrl}" alt="${item.title}">
                        <div>
                            <h3>${item.title}</h3>
                            <p>${item.subtitle || ''}</p>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-edit" title="Edit">✏️</button>
                        <button class="btn-delete" title="Delete">🗑️</button>
                    </div>
                </div>
            `;
        }

        function renderGalleryItem(item) {
            const imageUrl = item.imageUrl ? `/${item.imageUrl}` : 'https://placehold.co/400x200/ccc/white?text=No+Image';
            return `
                <div class="current-item" data-id="${item.id}">
                    <div class="item-info">
                        <img src="${imageUrl}" alt="${item.category}">
                        <div>
                            <h3>${item.category}</h3>
                            <p>${item.imageUrl}</p>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-delete" title="Delete">🗑️</button>
                    </div>
                </div>
            `;
        }

        // --- loadDynamicData (Unchanged) ---
        async function loadDynamicData(endpoint, listElementId, renderFunction) {
            const listElement = document.getElementById(listElementId);
            if (!listElement) return;

            console.log(`Fetching ${endpoint}...`);
            const data = await fetchData(endpoint);
            itemCache[endpoint] = data; 
            listElement.innerHTML = "";
            
            if (data.length === 0) {
                listElement.innerHTML = "<p>No items found.</p>";
                return;
            }
            data.forEach(item => {
                listElement.innerHTML += renderFunction(item);
            });
            console.log(`Rendered ${endpoint}`);
        }

        // --- 🌟 NEW: Load About Data 🌟 ---
        async function loadAboutData() {
            console.log('Fetching about content...');
            try {
                // This is a public GET request
                const data = await fetchData('about'); 
                
                document.getElementById('about-mission').value = data.ourMission || '';
                document.getElementById('about-story').value = data.ourStory || '';
                console.log('Rendered about content');
            } catch (err) {
                console.error('Error loading about content:', err);
            }
        }


        // --- ADD Form Submit Handlers ---
        document.getElementById('form-add-event').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            sendFormData("/api/events", formData, 'POST');
            e.target.reset();
        });

        document.getElementById('form-add-location').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            sendFormData("/api/locations", formData, 'POST');
            e.target.reset();
        });

        document.getElementById('form-add-photo').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            sendFormData("/api/gallery", formData, 'POST');
            e.target.reset();
        });

        // 🌟 NEW: About Form Submit Handler 🌟
        document.getElementById('form-manage-about').addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                ourMission: formData.get('ourMission'),
                ourStory: formData.get('ourStory')
            };
            sendJSONData("/api/about", data, 'PUT');
        });


        // --- 🌟 FIXED: EDIT / DELETE Click Handlers 🌟 ---
        mainContent.addEventListener('click', async (e) => {
            const editButton = e.target.closest('.btn-edit');
            const deleteButton = e.target.closest('.btn-delete');
            
            // --- Handle EDIT ---
            if (editButton) {
                e.preventDefault();
                const itemElement = e.target.closest('.current-item');
                const listElement = e.target.closest('.current-item-list');
                const id = itemElement.dataset.id;
                let endpoint = '';
                let itemData = null;

                if (listElement.id === 'locations-list') {
                    endpoint = 'locations';
                    // 🌟 Fetch full item data for modal
                    itemData = await fetchData(`locations/${id}`);
                } else if (listElement.id === 'events-list') {
                    endpoint = 'events';
                    // 🌟 Fetch full item data for modal
                    itemData = await fetchData(`events/${id}`);
                }

                if (!itemData) {
                    console.error("Could not find or fetch item!", id);
                    return;
                }
                
                // --- Populate Modal ---
                const showFields = (ids, show) => {
                    ids.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.style.display = show ? 'block' : 'none';
                    });
                };
                
                editForm.reset();

                // Set shared fields
                document.getElementById('edit-modal-title').textContent = `Edit ${itemData.title || 'Item'}`;
                document.getElementById('edit-item-id').value = itemData.id;
                document.getElementById('edit-item-endpoint').value = endpoint;
                document.getElementById('edit-title').value = itemData.title;

                const imgPreview = document.getElementById('edit-current-image-preview');
                if (itemData.imageUrl) {
                    imgPreview.src = `/${itemData.imageUrl}`;
                    imgPreview.style.display = 'block';
                    document.getElementById('edit-item-existing-image').value = itemData.imageUrl;
                } else {
                    imgPreview.style.display = 'none';
                    document.getElementById('edit-item-existing-image').value = '';
                }

                if (endpoint === 'locations') {
                    showFields(['edit-group-subtitle', 'edit-group-description', 'edit-group-location-details', 'edit-group-grid-image-preview', 'edit-group-grid-image-upload'], true);
                    showFields(['edit-group-category', 'edit-group-event-details'], false);
                    
                    document.getElementById('edit-subtitle').value = itemData.subtitle || '';
                    document.getElementById('edit-description').value = itemData.description || '';
                    document.getElementById('edit-pastorName').value = itemData.pastorName || '';
                    document.getElementById('edit-phone').value = itemData.phone || '';
                    document.getElementById('edit-email').value = itemData.email || '';
                    document.getElementById('edit-address').value = itemData.address || '';
                    document.getElementById('edit-mailingAddress').value = itemData.mailingAddress || '';
                    document.getElementById('edit-googleMapEmbed').value = itemData.googleMapEmbed || '';

                    const detailImgPreview = document.getElementById('edit-current-detail-image-preview');
                    if (itemData.detailImageUrl) {
                        detailImgPreview.src = `/${itemData.detailImageUrl}`;
                        detailImgPreview.style.display = 'block';
                        document.getElementById('edit-item-existing-detail-image').value = itemData.detailImageUrl;
                    } else {
                        detailImgPreview.style.display = 'none';
                        document.getElementById('edit-item-existing-detail-image').value = '';
                    }

                } else if (endpoint === 'events') {
                    showFields(['edit-group-subtitle', 'edit-group-description', 'edit-group-event-details', 'edit-group-grid-image-preview', 'edit-group-grid-image-upload'], true);
                    showFields(['edit-group-category', 'edit-group-location-details'], false);
                    
                    document.getElementById('edit-subtitle').value = itemData.subtitle || '';
                    document.getElementById('edit-description').value = itemData.description || '';
                    document.getElementById('edit-fullDescription').value = itemData.fullDescription || '';
                    document.getElementById('edit-registrationNote').value = itemData.registrationNote || '';

                    const detailImgPreview = document.getElementById('edit-current-event-detail-image-preview');
                    if (itemData.detailImageUrl) {
                        detailImgPreview.src = `/${itemData.detailImageUrl}`;
                        detailImgPreview.style.display = 'block';
                        document.getElementById('edit-item-existing-detail-image').value = itemData.detailImageUrl;
                    } else {
                        detailImgPreview.style.display = 'none';
                        document.getElementById('edit-item-existing-detail-image').value = '';
                    }
                }

                editModal.classList.add('show');
            }

            // --- Handle DELETE (Unchanged) ---
            if (deleteButton) {
                e.preventDefault();
                const itemElement = e.target.closest('.current-item');
                const listElement = e.target.closest('.current-item-list');
                const id = itemElement.dataset.id;
                let endpoint = '';

                if (listElement.id === 'locations-list') endpoint = 'locations';
                else if (listElement.id === 'events-list') endpoint = 'events';
                else if (listElement.id === 'gallery-list') endpoint = 'gallery';

                if (endpoint && confirm('Are you sure you want to delete this item? This cannot be undone.')) {
                    try {
                        const res = await fetch(`/api/${endpoint}/${id}`, {
                            method: 'DELETE',
                            headers: { "Authorization": `Bearer ${token}` }
                        });
                        const result = await res.json();
                        if (res.ok) {
                            alert(result.message);
                            itemElement.remove(); 
                        } else {
                            alert(`Error: ${result.error}`);
                        }
                    } catch (err) {
                        console.error("Delete failed:", err);
                        alert("A network error occurred.");
                    }
                }
            }
        });

        // --- 🌟 FIXED: Modal Form Submit 🌟 ---
        editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const endpoint = formData.get('endpoint');
            const id = formData.get('id');
            
            if (endpoint === 'locations') {
                formData.delete('category');
                // Delete event-specific fields
                formData.delete('fullDescription');
                formData.delete('registrationNote');
                
                if (document.getElementById('edit-detail-image-file').files.length === 0) {
                    formData.delete('detailImage');
                }
            } else if (endpoint === 'events') {
                formData.delete('category');
                // Delete location-specific fields
                formData.delete('pastorName');
                formData.delete('phone');
                formData.delete('email');
                formData.delete('address');
                formData.delete('mailingAddress');
                formData.delete('googleMapEmbed');

                if (document.getElementById('edit-event-detail-image-file').files.length === 0) {
                    formData.delete('detailImage');
                }
            }

            if (document.getElementById('edit-image-file').files.length === 0) {
                formData.delete('image');
            }

            sendFormData(`/api/${endpoint}/${id}`, formData, 'PUT');
        });

        // --- Modal Close Button (Unchanged) ---
        document.getElementById('btn-cancel-edit').addEventListener('click', () => {
            editModal.classList.remove('show');
            editForm.reset();
        });
        editModal.addEventListener('click', (e) => {
            if (e.target === editModal) { 
                editModal.classList.remove('show');
                editForm.reset();
            }
        });

        // --- Load all data on init ---
        loadDynamicData('locations', 'locations-list', renderListItem);
        loadDynamicData('events', 'events-list', renderListItem);
        loadDynamicData('gallery', 'gallery-list', renderGalleryItem);
        loadAboutData(); // 🌟 NEW
    });
    </script>
</body>
</html>